---
title: Tiptoe Through the Houston Fire Department Data
author: Alan Jackson
date: '2022-10-11'
slug: tiptoe_through_HFD_data
categories:
  - Emergency
tags:
  - Houston
  - Mapping
keywords:
  - tech
---

##      A data project

So I have a job that runs every hour and scrapes the HFD incident page so that
I can capture all the HFD 911 calls.

This is a first look at that data, just to see what it says.

```{r setup, include=FALSE}
library(tidyverse)
library(stringr)
library(sf)
library(leaflet)
library(leaflet.extras)


path <- "/home/ajackson/Dropbox/Rprojects/Curated_Data_Files/HFD_Incidents/"

knitr::opts_chunk$set(echo = TRUE)
```

##    Read in all the files

Read in the files that have been downloaded so far and do a small amount of
cleanup.

```{r read in, message=FALSE, warning=FALSE, cache=TRUE}

filenames <- list.files(path = paste0(path, "Incrementals/"),
                        pattern="*_table.rds$")

filenames <- paste0(paste0(path, "Incrementals/"),filenames)

df <- filenames %>% 
  purrr::map_dfr(readRDS) %>% 
  unique() # get rid of duplicates

df <- df %>% 
  rename(Incident_type=`Incident Type`, 
         Cross_street=`Cross Street`,
         Call_time=`Call Time(Opened)`,
         Combined=`Combined Response`,
         Key=`Key Map`)

df <- df %>% 
  mutate(Incident_type=stringr::str_replace(Incident_type, "fire", "Fire")) %>% 
  mutate(Incident_type=stringr::str_replace(Incident_type, "FIRE", "Fire")) %>% 
  mutate(Incident_type=stringr::str_replace(Incident_type, "EVENT", "Event")) %>% 
  mutate(Incident_type=stringr::str_replace(Incident_type, "Ems", "EMS")) %>% 
  mutate(Incident_type=stringr::str_replace(Incident_type, "Leaking", "Leak")) %>% 
  mutate(Incident_type=stringr::str_replace(Incident_type, " on ", " "))  
  

```

##    Clean up incident type

Incident type needs a little consolidation, so here I lump a few things
together (like Arcing, Wire, and Transformer into Electrical).


```{r summary of types, message=FALSE, warning=FALSE}

df_summary <- df %>% 
  group_by(Incident_type) %>% 
    summarize(n=n())

df <- df %>% 
  mutate(Category=case_when(
    str_detect(Incident_type, "Fire") ~ "Fire",
    str_detect(Incident_type, "EMS") ~ "EMS",
    str_detect(Incident_type, "Check Patient") ~ "Check Patient",
    str_detect(Incident_type, "CRASH") ~ "Crash",
    str_detect(Incident_type, "TRAFFIC") ~ "Crash",
    str_detect(Incident_type, "Vehicle") ~ "Crash",
    str_detect(Incident_type, "Motorcycle") ~ "Crash",
    str_detect(Incident_type, "Gas") ~ "Gas Leak",
    str_detect(Incident_type, "Alarm") ~ "Alarm",
    str_detect(Incident_type, "Smoke Detector") ~ "Alarm",
    str_detect(Incident_type, "Pedestrian") ~ "Pedestrian",
    str_detect(Incident_type, "Arcing") ~ "Electrical",
    str_detect(Incident_type, "Transformer") ~ "Electrical",
    str_detect(Incident_type, "Wire") ~ "Electrical",
    str_detect(Incident_type, "Electrical") ~ "Electrical",
    str_detect(Incident_type, "Elevator") ~ "Elevator",
    TRUE ~ "Other"
  ))

df %>% 
  group_by(Category) %>% 
    summarize(n=n()) %>% 
  arrange(-n) %>% 
  gt::gt()

df_sum <- df %>%
  group_by(Key) %>% 
    summarize(num=n())

```


##   Attach Keymaps and Census Data

Many of the incidents are located only by Keymap code. Some instead have an 
address. For those, we will try to geocode the address and then attach a
KeyMap code for that address.

When that is done, we will then attach some census data to the incidents.


```{r coordinates, warning=FALSE, message=FALSE, cache=TRUE}

library(postmastr)
library(GeocodeHou)

googlecrs <- "EPSG:4326" # lat long
CoH_crs <- "EPSG:2278" # X-Y

Keyfiles <- readRDS(paste0("/home/ajackson/Dropbox/Rprojects/Curated_Data_Files/Keymaps/", "Trans_Tab.rds"))
Keypolys <- readRDS(paste0("/home/ajackson/Dropbox/Rprojects/Curated_Data_Files/Keymaps/", "Trans_Tab_Poly_ll.rds"))

df <- df %>% 
  mutate(Seq=row_number()) %>% 
  mutate(Time=lubridate::hour(lubridate::mdy_hm(Call_time))) %>% 
  mutate(Daytime=if_else(Time<6|Time>18,FALSE, TRUE))

dfnew <- left_join(df, Keyfiles, by="Key")
dfnew <- sf::st_as_sf(dfnew)

#     Many have no Key, but some have an address. Geocode and then match to Key

foo <- dfnew %>% 
  filter(Key=="") %>% 
  filter(!Address=="") %>% 
  mutate(Zip="77000") %>% #  bogus zipcode
  mutate(St_num=stringr::str_extract(Address, "^\\d*")) %>% 
  filter(!St_num=="") 
foo <- pm_identify(foo, var="Address") # add ID fields
foo2 <- pm_prep(foo, var="Address", type="street") # Prep data
foo2 <- pm_houseFrac_parse(foo2)
foo2 <- pm_house_parse(foo2)
foo2 <- pm_streetDir_parse(foo2)
foo2 <- pm_streetSuf_parse(foo2)
foo2 <- pm_street_parse(foo2)
foo2 <- foo2 %>% 
  mutate(pm.street=str_to_upper(pm.street)) %>% 
  mutate(pm.streetSuf=str_to_upper(pm.streetSuf)) %>% 
  mutate(pm.preDir=replace_na(pm.preDir, "")) %>% 
  mutate(pm.streetSuf=replace_na(pm.streetSuf, ""))
foo <- pm_replace(foo2, source=foo)

match <- NULL
for (i in 1:nrow(foo)){ # match to get zipcode
  if (is.na(foo[i,]$pm.street)) {next}
  print(paste("i=",i))
  tmp <- GeocodeHou::repair_zipcode(foo[i,]$pm.house, 
                        foo[i,]$pm.preDir,
                        foo[i,]$pm.street,
                        foo[i,]$pm.streetSuf, 
                        foo[i,]$Zip)
  if (tmp$Success){ #   success
    print(paste("Success", tmp$Lat, tmp$Lon, tmp$New_zipcode))
    match <- cbind(foo[i,], tmp) %>% 
      select(pm.house, pm.preDir, pm.street, pm.streetSuf, New_zipcode, Seq, Lat, Lon) %>% 
      rbind(., match)
  } else { #  Fail exact match
    print(paste("Failed", tmp$Fail))
  }
}

#   Use lat long to find which keymap key

match_ll <- st_as_sf(match, coords=c("Lon", "Lat"), crs=googlecrs) 

aaa <- st_intersects(st_transform(match_ll, crs=CoH_crs), 
                                    st_transform(Keypolys, crs=CoH_crs), 
                                    sparse=TRUE) 

aaab <-Keypolys[unlist(aaa),] %>% 
  st_drop_geometry() %>% 
  select(Key) %>% 
  bind_cols(., st_drop_geometry(match_ll)) %>% 
  select(Key, Seq)

mask <- dfnew$Seq %in% aaab$Seq

dfnew[dfnew$Seq %in% aaab$Seq,]$Key <- aaab$Key

#   Drop rows without a Keymap code
  
dfnew <- dfnew %>% 
  filter(!Key=="")

#   Sum up by Keymap, daytime or night, and Category

dfnew_sum <- dfnew %>% 
  group_by(Category, Key, Daytime) %>% 
    summarise(n=n())

#   Attach some census data

censuspath <- "/home/ajackson/Dropbox/Rprojects/Curated_Data_Files/Census_data/"
censusKey <- readRDS(paste0(censuspath, "Census_data_by_Keymap_2020.rds")) %>% 
  select(Key, Pop, Pop_white, Pop_black, Pop_asian, Pop_hispanic, Pop_not_hisp,
         Pop_blk_grpE, Aggreg_incE) %>% 
  mutate(Avg_income=na_if(Aggreg_incE/Pop_blk_grpE, Inf))

df_all <- left_join(dfnew_sum, censusKey, by="Key")

df_all_poly <- left_join(st_drop_geometry(df_all), Keypolys, by="Key")
df_all_poly <- sf::st_as_sf(df_all_poly)

```

##        Crossplots

Looking at EMS calls, since I want to compare those to the income to look
for anomalies, we restrict the time to night-time since that is when
income is meaningful - people are largely at home in bed.

```{r crossplots}

df_EMS_day <- df_all_poly %>% 
  filter(Category=="EMS") %>% 
  filter(n>10) %>% 
  filter(Daytime)

df_EMS_nite <- df_all_poly %>% 
  filter(Category=="EMS") %>% 
  filter(n>10) %>% 
  filter(!Daytime)

foo <- df_EMS_nite %>% 
  filter(!is.na(Pop)) %>% 
  filter(Pop>100) %>% 
  mutate(percap=n/Pop)

foo %>% 
  ggplot(aes(y=Avg_income, x=percap)) +
    geom_point()



```


##    Some maps of polygons

```{r some polygons}

# Produces a ggplot object
bbox <- osmdata::getbb(place_name = "Houston")
sf::st_bbox()
Base_basemapR <- basemapR::base_map(bbox, basemap="mapnik", increase_zoom=2)

#   First just raw numbers

df_EMS_day <- df_all_poly %>% 
  filter(Category=="EMS") %>% 
  filter(n>10) %>% 
  filter(Daytime)

df_EMS_day %>% 
  filter(n>50) %>%  
ggplot() +
  Base_basemapR +
  geom_sf(aes(fill=n), alpha=0.3)+
  scale_fill_gradientn(colors=rainbow(5), limits=c(50,300))

df_EMS_nite <- df_all_poly %>% 
  filter(Category=="EMS") %>% 
  filter(n>10) %>% 
  filter(!Daytime)

df_EMS_nite %>% 
  filter(n>50) %>%  
ggplot() +
  Base_basemapR +
  geom_sf(aes(fill=n), alpha=0.3)+
  scale_fill_gradientn(colors=rainbow(5), limits=c(50,300))

#   Improved scales

  pal <- colorQuantile(palette = heat.colors(5), 
                       domain = df_EMS$n, 
                       n = 5, 
                       na.color = "transparent", 
                       alpha = FALSE, 
                       right = FALSE) 

df_EMS %>% 
ggplot() +
  Base_basemapR +
  geom_sf(aes(fill=n), alpha=0.3)+
  scale_fill_gradientn(colors=pal(df_EMS$n))


#     Let's do per capita

#   First the blocks with no people resident

df_EMS %>% 
  filter(is.na(Pop)) %>% 
  ggplot() +
    Base_basemapR +
    geom_sf(aes(fill=n), alpha=0.3)+
    scale_fill_gradientn(colors=rainbow(5), limits=c(10,200))
  
#   These are either the airport or outside of Harris County

#   Now do per capita

df_EMS_nite %>% 
  filter(!is.na(Pop)) %>% 
  mutate(percap=n/Pop) %>% 
  ggplot() +
    Base_basemapR +
    geom_sf(aes(fill=percap), alpha=0.3)+
    scale_fill_gradientn(colors=rainbow(5), limits=c(0, 2))
  
#   Let's look at blocks with real population.

df_EMS_nite %>% 
  filter(!is.na(Pop)) %>% 
  summary()

df_EMS_nite %>% 
  filter(!is.na(Pop)) %>% 
  filter(Pop>1000) %>% 
  mutate(percap=n/Pop) %>% 
  filter(percap>0.01) %>% 
  ggplot() +
    Base_basemapR +
    geom_sf(aes(fill=percap), alpha=0.3)+
    scale_fill_gradientn(colors=rainbow(5), limits=c(0.01, 0.1))

```


##    Let's make some maps

```{r maps, eval=FALSE}

########################################
knitr::knit_exit()
########################################

dfnew %>%
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions(),
             label=~as.character(Key))

dfnew %>%
  filter(str_detect(Incident_type, "Dumpster")) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions())

dfnew %>%
  filter(str_detect(Incident_type, "CRASH")) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions(),
             label=~as.character(Key))

dfnew %>%
  filter(str_detect(Incident_type, "Fire")) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions(),
             label=~as.character(Key))

```



